<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=600, initial-scale=1">
    <title>烘豆紀錄總覽</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .summary-title {
            background: linear-gradient(90deg,#1976d2,#2196f3);
            color: #fff;
            border-radius: 16px 16px 0 0;
            padding: 18px 0 12px 0;
            text-align: center;
            font-size: 1.35em;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 24px;
        }
        .summary-cards {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 32px;
        }
        .summary-card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 12px #1976d233;
            padding: 24px 0 16px 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .summary-num {
            font-size: 2.6em;
            color: #1976d2;
            font-weight: 700;
            margin-bottom: 0.2em;
        }
        .summary-label {
            font-size: 1.08em;
            color: #888;
            letter-spacing: 1px;
        }
        .summary-title {
            background: linear-gradient(90deg,#1976d2,#2196f3);
            color: #fff;
            border-radius: 16px 16px 0 0;
            padding: 18px 0 12px 0;
            text-align: center;
            font-size: 1.35em;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 24px;
        }
        .summary-cards {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 32px;
        }
        .summary-card {
            background: #fff;
            border-radius: 22px;
            box-shadow: 0 4px 24px #1976d233;
            padding: 32px 0 18px 0;
            text-align: center;
        }
        .summary-card .summary-num {
            font-size: 2.8em;
            color: #1976d2;
            font-weight: 700;
            line-height: 1;
        }
        .summary-card .summary-label {
            font-size: 1.1em;
            color: #888;
            margin-top: 10px;
            letter-spacing: 1px;
        }
        body { background: #f6f9fc; font-family: 'Noto Sans TC', '微軟正黑體', sans-serif; }
        .container {
            width: 430px;
            max-width: 98vw;
            min-width: 350px;
            margin: 32px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px #0001;
            padding: 24px 18px 18px 18px;
        }
        .summary-box {
            background: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            margin: 0 0 18px 0;
            max-width: 100%;
        }
        th, td {
            text-align: center;
            vertical-align: middle;
            font-size: 14px;
            white-space: nowrap;
            height: 36px;
            padding-top: 0;
            padding-bottom: 0;
        }
        .record-table {
            overflow-x: auto;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 摘要區 -->
        <div class="summary-title" style="display:flex;align-items:center;justify-content:flex-start;position:relative;padding:0;min-height:60px;">
            <button id="backBtn" class="btn btn-link" style="background:rgba(0,0,0,0.08);border-radius:10px;padding:0 10.24px 0 6.4px;height:25.6px;display:flex;align-items:center;position:absolute;left:18px;top:50%;transform:translateY(-50%);color:#fff;font-size:0.69em;text-decoration:none;">
                <span style="display:flex;align-items:center;justify-content:center;width:12.8px;height:12.8px;margin-right:3.84px;">
                    <svg viewBox="0 0 16 16" width="12.8" height="12.8" fill="currentColor"><path d="M10.5 3.5a.75.75 0 0 1 0 1.06L6.06 9l4.44 4.44a.75.75 0 1 1-1.06 1.06l-5-5a.75.75 0 0 1 0-1.06l5-5a.75.75 0 0 1 1.06 0z"></path></svg>
                </span>
                <span style="display:flex;align-items:center;">返回</span>
            </button>
            <span style="flex:1;text-align:center;display:flex;align-items:center;justify-content:center;font-size:1.16em;font-weight:700;letter-spacing:1px;">查看過往紀錄</span>
        </div>
        <script>
        document.getElementById('backBtn').onclick = function() {
            window.location.href = 'splash.html';
        };
        </script>
        <div class="summary-cards">
            <div class="summary-card">
                <div id="totalCount" class="summary-num">0</div>
                <div class="summary-label">總記錄數</div>
            </div>
            <div class="summary-card">
                <div id="totalWeight" class="summary-num">0g</div>
                <div class="summary-label">總烘豆重量</div>
            </div>
            <div class="summary-card">
                <div id="totalTime" class="summary-num">0:00:00</div>
                <div class="summary-label">總烘豆時間</div>
            </div>
        </div>
        <!-- 篩選區塊 -->
        <div class="filter-box" style="background:#f5fbff;border-radius:18px;box-shadow:0 2px 12px #0001;padding:22px 18px 18px 18px;">
            <div style="font-weight:600;font-size:1.15em;color:#1976d2;margin-bottom:12px;display:flex;align-items:center;">
                <i class="fa fa-filter" style="font-size:1.2em;margin-right:7px;"></i> 篩選條件
            </div>
            <div class="mb-2">
                <label style="font-weight:500;">日期範圍</label>
                <input type="date" class="form-control mb-1" id="filterStart" style="border-radius:8px;">
                <span style="font-size:0.95em;color:#888;">至</span>
                <input type="date" class="form-control" id="filterEnd" style="border-radius:8px;">
            </div>
            <div class="mb-2">
                <label style="font-weight:500;">烘焙度</label>
                <select class="form-control" id="filterRoast" style="border-radius:8px;">
                    <option value="">全部</option>
                </select>
            </div>
            <div class="mb-2">
                <label style="font-weight:500;">搜尋</label>
                <input type="text" class="form-control" id="filterSearch" placeholder="搜尋記錄..." style="border-radius:8px;">
            </div>
            <button class="btn btn-primary w-100" id="filterBtn" style="border-radius:8px;font-weight:600;font-size:1.1em;"><i class="fa fa-search me-1"></i> 篩選</button>
        </div>
        <!-- 列表區塊 -->
        <div class="record-table" style="background:none;box-shadow:none;margin-top:18px;">
            <div style="background:#1976d2;color:#fff;border-radius:14px 14px 0 0;padding:10px 0 10px 0;font-weight:600;font-size:1.15em;display:flex;align-items:center;">
                <i class="fa fa-undo" style="font-size:1.2em;margin-left:18px;margin-right:7px;"></i> 烘豆記錄列表
                <div style="margin-left:auto;margin-right:18px;display:flex;gap:12px;">
                    <button class="btn btn-sm" id="viewModeBtn" style="background:none;width:38px;height:38px;display:flex;align-items:center;justify-content:center;border:none;border-radius:10px;padding:0;margin-left:18px;">
                        <img src="./icons/觀看.png" style="width:30px;height:30px;object-fit:contain;" />
                    </button>
                    <button class="btn btn-sm" id="editModeBtn" style="background:none;width:38px;height:38px;display:flex;align-items:center;justify-content:center;border:none;border-radius:10px;padding:0;margin-left:10px;">
                        <img src="./icons/編輯.png" style="width:30px;height:30px;object-fit:contain;" />
                    </button>
                    <button class="btn btn-sm" id="deleteModeBtn" style="background:none;width:38px;height:38px;display:flex;align-items:center;justify-content:center;border:none;border-radius:10px;padding:0;margin-left:10px;">
                        <img src="./icons/刪除.png" style="width:30px;height:30px;object-fit:contain;" />
                    </button>
                </div>
            </div>
            <table class="table table-bordered mb-0" id="historyTable" style="border-radius:0 0 14px 14px;overflow:hidden;">
                <thead style="background:#e3f2fd;">
                    <tr id="historyHeader"></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
function viewRecord(idx) {
    window.location.href = `view_detail.html?idx=${idx}`;
}
window.renderTable = function renderTable(history) {
    const header = ['日期','豆種','入豆重','出豆重','失重率(%)','烘焙度','總時間','熱機溫度','出豆溫度','一爆時間','一爆溫度','二爆時間','二爆溫度'];
    const thead = document.getElementById('historyHeader');
    // 依照最新版.html，動態展開 tempPowerArr 欄位
    const baseHeader = ['日期','豆種','入豆重','出豆重','失重率(%)','烘焙度','總時間','熱機溫度','出豆溫度','一爆時間','一爆溫度','二爆時間','二爆溫度'];
    let tempHeaders = [];
    if (!Array.isArray(history)) history = [];
    if (history.length && history[0].tempPowerArr) {
        history[0].tempPowerArr.forEach((row, idx) => {
            tempHeaders.push(`<th>${row.time1}溫度</th><th>${row.time1}火力</th><th>${row.time2}溫度</th><th>${row.time2}火力</th>`);
        });
    }
    let opMode = window._opMode || '';
    let opHeader = '';
    if (opMode === 'edit' || opMode === 'delete' || opMode === 'view') {
        opHeader = '<th style="min-width:120px;">操作</th>';
    }
    thead.innerHTML = opHeader + baseHeader.map(h=>`<th>${h}</th>`).join('') + tempHeaders.join('');
    const tbody = document.getElementById('historyTable').querySelector('tbody');
    tbody.innerHTML = '';
    if (history.length) {
        history.forEach((item, idx) => {
            // 自動同步 detailArr
            if (Array.isArray(item.tempPowerArr)) {
                item.detailArr = [];
                let reachedEnd = false;
                for (const row of item.tempPowerArr) {
                    if (reachedEnd) break;
                    // time1
                    if (row.time1 && isValidTime(row.time1)) {
                        item.detailArr.push({
                            time: row.time1,
                            temp: row.temp1 || '--',
                            power: row.power1 || '--'
                        });
                        if (row.time1 === '8:30') { reachedEnd = true; break; }
                    }
                    // 非標準時間直接跳過
                    else if (row.time1 && !isValidTime(row.time1)) {
                        continue;
                    }
                    if (reachedEnd) break;
                    // time2
                    if (row.time2 && isValidTime(row.time2)) {
                        item.detailArr.push({
                            time: row.time2,
                            temp: row.temp2 || '--',
                            power: row.power2 || '--'
                        });
                        if (row.time2 === '8:30') { reachedEnd = true; break; }
                    }
                    else if (row.time2 && !isValidTime(row.time2)) {
                        continue;
                    }
                }
                // 工具函式：只允許 mm:ss 且不超過 8:30
                function isValidTime(t) {
                    if (!t || typeof t !== 'string') return false;
                    const match = t.match(/^([0-9]{1,2}):([0-9]{2})$/);
                    if (!match) return false;
                    const min = parseInt(match[1],10);
                    const sec = parseInt(match[2],10);
                    const totalSec = min*60 + sec;
                    return totalSec <= 8*60+30;
                }
            }
            const tr = document.createElement('tr');
            let tempPowerHtml = '';
            if (item.tempPowerArr && item.tempPowerArr.length) {
                tempPowerHtml = item.tempPowerArr.map(row => {
                    return `<td style='height:36px;'>${row.temp1}</td><td style='height:36px;'>${row.power1}</td><td style='height:36px;'>${row.temp2}</td><td style='height:36px;'>${row.power2}</td>`;
                }).join('');
            }
            let opCell = '';
            let isEditing = window._editingIdx === idx;
            if (opMode === 'delete') {
                opCell = `<td><button class='btn btn-xs btn-outline-danger' onclick='confirmDeleteRecord(${idx})' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;line-height:1;'>刪除</button></td>`;
            } else if (opMode === 'edit') {
                if (isEditing) {
                    opCell = `<td style='display:flex;gap:4px;'>
                        <button class='btn btn-xs btn-success' onclick='saveEdit(${idx})' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;'>儲存</button>
                        <button class='btn btn-xs btn-secondary' onclick='cancelEdit()' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;'>取消</button>
                    </td>`;
                } else {
                    opCell = `<td><button class='btn btn-xs btn-outline-warning' onclick='startEdit(${idx})' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;line-height:1;'>編輯</button></td>`;
                }
            } else if (opMode === 'view') {
                opCell = `<td><button class='btn btn-xs btn-outline-primary' onclick='viewRecord(${idx})' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;line-height:1;'>查看</button></td>`;
            }
// 刪除功能：跳出確認視窗，確認後刪除（全域註冊）
window.confirmDeleteRecord = function(idx) {
    if (confirm('確定要刪除這筆烘豆紀錄嗎？此操作無法復原！')) {
        let history = JSON.parse(localStorage.getItem('roastHistory')||'[]');
        history.splice(idx, 1);
        localStorage.setItem('roastHistory', JSON.stringify(history));
        renderTable(history);
    }
}
            if (opMode === 'edit' && isEditing) {
                tr.innerHTML = `
                    ${opCell}
                    <td><input type='text' class='form-control form-control-sm' id='edit_date' value='${item.date||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_beanType' value='${item.beanType||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_inputWeight' value='${item.inputWeight||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_outputWeight' value='${item.outputWeight||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_lossRate' value='${item.lossRate||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_roastLevel' value='${item.roastLevel||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_totalTime' value='${item.totalTime||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_preheatTemp' value='${item.preheatTemp||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_outputTemp' value='${item.outputTemp||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_firstCrackTime' value='${item.firstCrackTime||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_firstCrackTemp' value='${item.firstCrackTemp||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_secondCrackTime' value='${item.secondCrackTime||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    <td><input type='text' class='form-control form-control-sm' id='edit_secondCrackTemp' value='${item.secondCrackTemp||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                    ${item.tempPowerArr && item.tempPowerArr.length ? item.tempPowerArr.map((row, i) => {
                        return `
                        <td><input type='text' class='form-control form-control-sm' id='edit_temp1_${i}' value='${row.temp1||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_power1_${i}' value='${row.power1||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_temp2_${i}' value='${row.temp2||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_power2_${i}' value='${row.power2||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        `;
                    }).join('') : ''}
                `;
            } else {
                tr.innerHTML = `
                    ${opMode === 'edit' || opMode === 'delete' || opMode === 'view' ? opCell : ''}
                    <td>${item.date || ''}</td>
                    <td>${item.beanType || ''}</td>
                    <td>${item.inputWeight || ''}</td>
                    <td>${item.outputWeight || ''}</td>
                    <td>${item.lossRate || ''}</td>
                    <td>${item.roastLevel || ''}</td>
                    <td>${item.totalTime || ''}</td>
                    <td>${item.preheatTemp || ''}</td>
                    <td>${item.outputTemp || ''}</td>
                    <td>${item.firstCrackTime || ''}</td>
                    <td>${item.firstCrackTemp || ''}</td>
                    <td>${item.secondCrackTime || ''}</td>
                    <td>${item.secondCrackTemp || ''}</td>
                    ${tempPowerHtml}
                `;
            }
window.startEdit = function(idx) {
    window._opMode = 'edit';
    window._editingIdx = idx;
    window.renderTable(window.roastHistory);
}
window.saveEdit = function(idx) {
    var item = window.roastHistory[idx];
    item.date = document.getElementById('edit_date').value;
    item.beanType = document.getElementById('edit_beanType').value;
    item.inputWeight = document.getElementById('edit_inputWeight').value;
    item.outputWeight = document.getElementById('edit_outputWeight').value;
    item.lossRate = document.getElementById('edit_lossRate').value;
    item.roastLevel = document.getElementById('edit_roastLevel').value;
    item.totalTime = document.getElementById('edit_totalTime').value;
    item.preheatTemp = document.getElementById('edit_preheatTemp').value;
    item.outputTemp = document.getElementById('edit_outputTemp').value;
    item.firstCrackTime = document.getElementById('edit_firstCrackTime').value;
    item.firstCrackTemp = document.getElementById('edit_firstCrackTemp').value;
    item.secondCrackTime = document.getElementById('edit_secondCrackTime').value;
    item.secondCrackTemp = document.getElementById('edit_secondCrackTemp').value;
    if (item.tempPowerArr && item.tempPowerArr.length) {
        item.tempPowerArr.forEach(function(row, i) {
            row.temp1 = document.getElementById('edit_temp1_' + i).value;
            row.power1 = document.getElementById('edit_power1_' + i).value;
            row.temp2 = document.getElementById('edit_temp2_' + i).value;
            row.power2 = document.getElementById('edit_power2_' + i).value;
        });
    }
    window._editingIdx = null;
    window._opMode = '';
    localStorage.setItem('roastHistory', JSON.stringify(window.roastHistory));
    window.renderTable(window.roastHistory);
}
window.cancelEdit = function() {
    window._editingIdx = null;
    window._opMode = '';
    window.renderTable(window.roastHistory);
}
            tr.style.height = '36px';
            tbody.appendChild(tr);
        });
        // 每次渲染後自動存回 localStorage，確保 detailArr 同步
        localStorage.setItem('roastHistory', JSON.stringify(history));
    } else {
        // 無資料時顯示提示
        tbody.innerHTML = `<tr><td colspan="20" style="text-align:center;color:#888;">尚無烘豆記錄</td></tr>`;
    }
}
    function pad(num) { return String(num).padStart(2, '0'); }
    function sumTime(times) {
        let totalSec = 0;
        times.forEach(t => {
            if (typeof t === 'string' && t.includes(':')) {
                let [m,s] = t.split(':');
                totalSec += parseInt(m)*60 + parseInt(s);
            }
        });
        let h = Math.floor(totalSec/3600);
        let m = Math.floor((totalSec%3600)/60);
        let s = totalSec%60;
        return `${pad(h)}:${pad(m)}:${pad(s)}`;
    // 移除多餘的大括號
    function renderSummary(history) {
    document.getElementById('totalCount').textContent = history.length;
    let totalWeight = history.reduce((sum, item) => sum + (parseFloat(item.inputWeight)||0), 0);
    document.getElementById('totalWeight').textContent = `${totalWeight}g`;
    let totalTime = sumTime(history.map(item => item.totalTime));
    document.getElementById('totalTime').textContent = totalTime;
    }
    function renderRoastOptions(history) {
        const select = document.getElementById('filterRoast');
        let roastSet = new Set(history.map(item => item.roastLevel).filter(Boolean));
        select.innerHTML = '<option value="">全部</option>' + Array.from(roastSet).map(r=>`<option value="${r}">${r}</option>`).join('');
    }
    window.renderTable = function renderTable(history) {
        const header = ['日期','豆種','入豆重','出豆重','失重率(%)','烘焙度','總時間','熱機溫度','出豆溫度','一爆時間','一爆溫度','二爆時間','二爆溫度'];
        const thead = document.getElementById('historyHeader');
        // 依照最新版.html，動態展開 tempPowerArr 欄位
        const baseHeader = ['日期','豆種','入豆重','出豆重','失重率(%)','烘焙度','總時間','熱機溫度','出豆溫度','一爆時間','一爆溫度','二爆時間','二爆溫度'];
        let tempHeaders = [];
        if (history.length && history[0].tempPowerArr) {
            history[0].tempPowerArr.forEach((row, idx) => {
                tempHeaders.push(`<th>${row.time1}溫度</th><th>${row.time1}火力</th><th>${row.time2}溫度</th><th>${row.time2}火力</th>`);
            });
        }
    let opMode = window._opMode || '';
    let opHeader = '';
    if (opMode === 'edit' || opMode === 'delete' || opMode === 'view') {
        opHeader = '<th style="min-width:120px;">操作</th>';
    }
    thead.innerHTML = opHeader + baseHeader.map(h=>`<th>${h}</th>`).join('') + tempHeaders.join('');
        const tbody = document.getElementById('historyTable').querySelector('tbody');
        tbody.innerHTML = '';
        if (history.length) {
            history.forEach((item, idx) => {
                const tr = document.createElement('tr');
                let tempPowerHtml = '';
                if (item.tempPowerArr && item.tempPowerArr.length) {
                    tempPowerHtml = item.tempPowerArr.map(row => {
                        return `<td style='height:36px;'>${row.temp1}</td><td style='height:36px;'>${row.power1}</td><td style='height:36px;'>${row.temp2}</td><td style='height:36px;'>${row.power2}</td>`;
                    }).join('');
                }
                let opCell = '';
                let isEditing = window._editingIdx === idx;
                if (opMode === 'view') {
                    opCell = `<td><button class='btn btn-xs btn-outline-primary' onclick='viewRecord(${idx})' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;line-height:1;'>查看</button></td>`;
                } else if (opMode === 'edit') {
                    if (isEditing) {
                        opCell = `<td style='display:flex;gap:4px;'>
                            <button class='btn btn-xs btn-success' onclick='saveEdit(${idx})' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;'>儲存</button>
                            <button class='btn btn-xs btn-secondary' onclick='cancelEdit()' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;'>取消</button>
                        </td>`;
                    } else {
                        opCell = `<td><button class='btn btn-xs btn-outline-warning' onclick='startEdit(${idx})' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;line-height:1;'>編輯</button></td>`;
                    }
                } else if (opMode === 'delete') {
                    opCell = `<td><button class='btn btn-xs btn-outline-danger' onclick='deleteRecord(${idx})' style='width:38px;height:24px;font-size:0.92em;padding:2px 6px;line-height:1;'>刪除</button></td>`;
                }
                if (opMode === 'edit' && isEditing) {
                    tr.innerHTML = `
                        ${opCell}
                        <td><input type='text' class='form-control form-control-sm' id='edit_date' value='${item.date||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_beanType' value='${item.beanType||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_inputWeight' value='${item.inputWeight||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_outputWeight' value='${item.outputWeight||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_lossRate' value='${item.lossRate||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_roastLevel' value='${item.roastLevel||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_totalTime' value='${item.totalTime||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_preheatTemp' value='${item.preheatTemp||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_outputTemp' value='${item.outputTemp||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_firstCrackTime' value='${item.firstCrackTime||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_firstCrackTemp' value='${item.firstCrackTemp||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_secondCrackTime' value='${item.secondCrackTime||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        <td><input type='text' class='form-control form-control-sm' id='edit_secondCrackTemp' value='${item.secondCrackTemp||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                        ${item.tempPowerArr && item.tempPowerArr.length ? item.tempPowerArr.map((row, i) => {
                            return `
                            <td><input type='text' class='form-control form-control-sm' id='edit_temp1_${i}' value='${row.temp1||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                            <td><input type='text' class='form-control form-control-sm' id='edit_power1_${i}' value='${row.power1||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                            <td><input type='text' class='form-control form-control-sm' id='edit_temp2_${i}' value='${row.temp2||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                            <td><input type='text' class='form-control form-control-sm' id='edit_power2_${i}' value='${row.power2||''}' style='height:24px;padding:2px 4px;font-size:0.92em;'/></td>
                            `;
                        }).join('') : ''}
                    `;
                } else {
                    tr.innerHTML = `
                        ${opCell}
                        <td>${item.date || ''}</td>
                        <td>${item.beanType || ''}</td>
                        <td>${item.inputWeight || ''}</td>
                        <td>${item.outputWeight || ''}</td>
                        <td>${item.lossRate || ''}</td>
                        <td>${item.roastLevel || ''}</td>
                        <td>${item.totalTime || ''}</td>
                        <td>${item.preheatTemp || ''}</td>
                        <td>${item.outputTemp || ''}</td>
                        <td>${item.firstCrackTime || ''}</td>
                        <td>${item.firstCrackTemp || ''}</td>
                        <td>${item.secondCrackTime || ''}</td>
                        <td>${item.secondCrackTemp || ''}</td>
                        ${tempPowerHtml}
                    `;
                }
                tr.style.height = '36px';
                tbody.appendChild(tr);
            });
        } else {
            // 無資料時顯示提示
            tbody.innerHTML = `<tr><td colspan="20" style="text-align:center;color:#888;">尚無烘豆記錄</td></tr>`;
        }
    // 編輯/刪除功能框架
    function editRecord(idx) {
        // 保留原功能，改用 startEdit 控制
    }
    function startEdit(idx) {
    window._opMode = 'edit';
    window._editingIdx = idx;
    window.renderTable(window.roastHistory);
    }
    window.startEdit = startEdit;
    window.saveEdit = saveEdit;
    window.cancelEdit = cancelEdit;
    }
    function cancelEdit() {
    window._editingIdx = null;
    window._opMode = '';
    window.renderTable(window.roastHistory);
    }
    function saveEdit(idx) {
    var item = window.roastHistory[idx];
    item.date = document.getElementById('edit_date').value;
    item.beanType = document.getElementById('edit_beanType').value;
    item.inputWeight = document.getElementById('edit_inputWeight').value;
    item.outputWeight = document.getElementById('edit_outputWeight').value;
    item.lossRate = document.getElementById('edit_lossRate').value;
    item.roastLevel = document.getElementById('edit_roastLevel').value;
    item.totalTime = document.getElementById('edit_totalTime').value;
    item.preheatTemp = document.getElementById('edit_preheatTemp').value;
    item.outputTemp = document.getElementById('edit_outputTemp').value;
    item.firstCrackTime = document.getElementById('edit_firstCrackTime').value;
    item.firstCrackTemp = document.getElementById('edit_firstCrackTemp').value;
    item.secondCrackTime = document.getElementById('edit_secondCrackTime').value;
    item.secondCrackTemp = document.getElementById('edit_secondCrackTemp').value;
    if (item.tempPowerArr && item.tempPowerArr.length) {
        item.tempPowerArr.forEach(function(row, i) {
            row.temp1 = document.getElementById('edit_temp1_' + i).value;
            row.power1 = document.getElementById('edit_power1_' + i).value;
            row.temp2 = document.getElementById('edit_temp2_' + i).value;
            row.power2 = document.getElementById('edit_power2_' + i).value;
        });
    }
    window._editingIdx = null;
    window._opMode = '';
    localStorage.setItem('roastHistory', JSON.stringify(window.roastHistory));
    window.renderTable(window.roastHistory);
    }
    function viewRecord(idx) {
        window.location.href = `view_detail.html?idx=${idx}`;
    }
    window.viewRecord = viewRecord;
    }
    function deleteRecord(idx) {
        if (confirm('確定要刪除第'+(idx+1)+'筆記錄？')) {
            let history = JSON.parse(localStorage.getItem('roastHistory')||'[]');
            history.splice(idx, 1);
            localStorage.setItem('roastHistory', JSON.stringify(history));
            loadHistory();
        }
    }
    function filterHistory(history) {
        let start = document.getElementById('filterStart').value;
        let end = document.getElementById('filterEnd').value;
        let roast = document.getElementById('filterRoast').value;
        return history.filter(item => {
            let pass = true;
            if (start && item.date < start) pass = false;
            if (end && item.date > end) pass = false;
            if (roast && item.roastLevel !== roast) pass = false;
            return pass;
        });
    }
    function loadHistory() {
        let history = [];
        try {
            history = JSON.parse(localStorage.getItem('roastHistory')||'[]');
        } catch(e) {
            history = [];
        }
    if (typeof renderSummary === 'function') {
        renderSummary(history);
    } else {
        // 直接顯示基本資料
        document.getElementById('totalCount').textContent = history.length;
        let totalWeight = history.reduce((sum, item) => sum + (parseFloat(item.inputWeight)||0), 0);
        document.getElementById('totalWeight').textContent = `${totalWeight}g`;
        let totalTime = (function(times){
            let totalSec = 0;
            times.forEach(t => {
                if (typeof t === 'string' && t.includes(':')) {
                    let [m,s] = t.split(':');
                    totalSec += parseInt(m)*60 + parseInt(s);
                }
            });
            let h = Math.floor(totalSec/3600);
            let m = Math.floor((totalSec%3600)/60);
            let s = totalSec%60;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        })(history.map(item => item.totalTime));
        document.getElementById('totalTime').textContent = totalTime;
    }
    if (typeof renderRoastOptions === 'function') {
        renderRoastOptions(history);
    } else {
        // 直接渲染烘焙度選項
        const select = document.getElementById('filterRoast');
        let roastSet = new Set(history.map(item => item.roastLevel).filter(Boolean));
        select.innerHTML = '<option value="">全部</option>' + Array.from(roastSet).map(r=>`<option value="${r}">${r}</option>`).join('');
    }
    // 確保表格正確渲染 roastHistory 資料
    renderTable(history);
    // 若無資料顯示提示
    if (!history.length) {
        const tbody = document.getElementById('historyTable').querySelector('tbody');
        tbody.innerHTML = `<tr><td colspan="20" style="text-align:center;color:#888;">尚無烘豆記錄</td></tr>`;
    }
        document.getElementById('filterBtn').onclick = function() {
            let filtered = filterHistory(history);
            renderSummary(filtered);
            renderTable(filtered);
        };
        // 若無資料顯示提示
        if (!history.length) {
            const tbody = document.getElementById('historyTable').querySelector('tbody');
            tbody.innerHTML = `<tr><td colspan="20" style="text-align:center;color:#888;">尚無烘豆記錄</td></tr>`;
        }
    }
    window.addEventListener('DOMContentLoaded', loadHistory);
// 自動匯入主表單現有資料
function autoImportHistory() {
    let history = [];
    try {
        history = JSON.parse(localStorage.getItem('roastHistory')||'[]');
    } catch(e) {
        history = [];
    }
    if (!history.length) {
        // 若無資料，自動匯入一筆範例
        history = [{
            date: '2025-09-02',
            beanType: '耶加雪菲',
            inputWeight: '200',
            outputWeight: '170',
            lossRate: '15',
            roastLevel: '中烘焙',
            totalTime: '10:00',
            preheatTemp: '180',
            outputTemp: '210',
            firstCrackTime: '7:30',
            firstCrackTemp: '195',
            secondCrackTime: '9:30',
            secondCrackTemp: '205',
            tempPowerArr: [
                {time1:'0:00',temp1:'180',power1:'80',time2:'0:30',temp2:'182',power2:'80'},
                {time1:'1:00',temp1:'185',power1:'80',time2:'1:30',temp2:'188',power2:'80'},
                {time1:'2:00',temp1:'190',power1:'80',time2:'2:30',temp2:'192',power2:'80'}
            ]
        }];
        localStorage.setItem('roastHistory', JSON.stringify(history));
    }
}
window.addEventListener('DOMContentLoaded', function() {
    autoImportHistory();
    document.getElementById('viewModeBtn').onclick = function() {
        window._opMode = (window._opMode === 'view') ? '' : 'view';
        window.renderTable(window.roastHistory);
    };
    document.getElementById('editModeBtn').onclick = function() {
        window._opMode = (window._opMode === 'edit') ? '' : 'edit';
        window.renderTable(window.roastHistory);
    };
    document.getElementById('deleteModeBtn').onclick = function() {
        window._opMode = (window._opMode === 'delete') ? '' : 'delete';
        window.renderTable(window.roastHistory);
    };
    window.roastHistory = JSON.parse(localStorage.getItem('roastHistory')||'[]');
    window.renderTable(window.roastHistory);
});
    </script>
</body>
</html>
